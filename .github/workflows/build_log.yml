name: Compile and Log

on: 
  workflow_dispatch: # 手动点击按钮触发

jobs:
  compile-job:
    runs-on: ubuntu-latest
    steps:
      # 1. 下载代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 开启 KVM (虽然只编译不运行可能不需要，但为了环境一致性建议保留)
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      # 3. 执行编译并保存日志
      # 技巧：使用 '2>&1 | tee build.log' 将屏幕输出同时保存到文件中
      - name: Run Build & Capture Log
        run: |
          echo "Starting compilation..."
          
          # 运行 Docker 命令
          # 如果 make build 失败，脚本会自动报错并停止，任务状态变为“失败”
          docker run --rm \
            --privileged \
            --network=host \
            --device=/dev/kvm \
            -v ${{ github.workspace }}:/root/asterinas \
            asterinas/asterinas:0.16.1-20250922 \
            /bin/bash -c "cd /root/asterinas && make build" 2>&1 | tee build.log
            
          echo "Compilation finished."

      # 4. 无论成功还是失败，都上传日志文件
      # 'if: always()' 保证即使编译报错了，你也能下载到日志看看错在哪
      - name: Upload Log File
        if: always() 
        uses: actions/upload-artifact@v4
        with:
          name: compilation-log
          path: build.log
